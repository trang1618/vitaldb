---
title: "Read data"
output:
  html_document:
    highlight: tango
    toc: true
---

## Read in data and explore
```{r setup, message=FALSE, warning=FALSE}
library(dplyr)
library(readxl)
library(stringr)
library(lubridate)
```


```{r warning=FALSE}
load('data/gen-outcome.Rdata')
auto_pheno_df <- readr::read_csv('data/auto-mass-trans-phenotype.csv')
manual_labs <- read_excel('data/tf_pheno_Trang_SMLee_20200809-reference.xlsx', na = 'NA') %>% 
  # select(-start_mass_trans) %>% 
  {.}
unknown_patients <- manual_labs %>% 
  filter(had_mass_trans == 'unknown') %>% 
  pull(fileid) %>% 
  unique()

tf <- tf %>% filter(!fileid %in% unknown_patients)
cases <- cases %>% filter(!fileid %in% unknown_patients)
```

```{r}
all_times <- manual_labs %>% 
  mutate(SMLee_start_mass_trans = as_datetime(SMLee_start_mass_trans)) %>% 
  filter(!fileid %in% unknown_patients) %>%
  left_join(auto_pheno_df, by = 'fileid') %>% 
  mutate(correct_start_time = SMLee_start_mass_trans)

manual_times_df <- all_times %>% 
  filter(SMLee_start_mass_trans != auto_start_mass_trans) %>%
  select(fileid, auto_start_mass_trans, SMLee_start_mass_trans) %>% 
  distinct()
```

```{r}
just_start_times <- all_times %>% 
  select(fileid, correct_start_time) %>% 
  distinct() # NA means the patient DID NOT have massive transfusion

all_times %>% 
  select(fileid, correct_start_time) %>% 
  distinct() %>% 
  readr::write_csv('data/mass-trans-phenotype.csv')

all_times %>% 
  readr::write_csv('data/to-seungmi-checking.csv')

manual_times_df %>% 
  readr::write_csv('data/just-manual.csv')

```

