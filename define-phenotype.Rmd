---
title: "Read data"
output:
  html_document:
    highlight: tango
    toc: true
---

## Read in data and explore
```{r setup, message=FALSE, warning=FALSE}
# install.packages("readxl")
library(dplyr)
library(readxl)
library(stringr)
library(lubridate)

get_num_list <- function(val){
  # reformat the `val` column, e.g. get_num_list('#3-#5') = '3,4,5'
  if (grepl('-', val) || nrow(str_locate_all(val, '#')[[1]]) > 1){
    return(str_split(val, '-|#') %>% 
      unlist() %>%
      gsub('#|,', '', .) %>% 
      as.integer() %>% 
      na.omit() %>% 
      as.list() %>% 
      do.call('seq.int', .) %>% 
      paste(collapse = ','))
  }
  gsub('#', '', val)
}
```

```{r warning=FALSE}
nms <- names(read_excel('data/cases.xlsx', n_max = 0))
ct <- vector(mode = 'character')
for (i in nms){
  ct <- c(ct, if (grepl('^em_yn|premedi_smoking|nurse_|caseid', i)){
  'text'
  } else if (grepl('postop_tnt_peak30|preop_tnt', i)) { # very high missing rate for these columns anyway
    'text'
  } else {'guess'})
}

cases <- read_excel('data/cases.xlsx', col_types = ct) %>% 
  mutate(em_yn = as.factor(em_yn),
         fileid = gsub('.vital', '', fileid))
# cases <- readr::read_csv('data/cases.xlsx')
# case_deets <- read_excel('data/cases-detail.xlsx')
# labs <- read_excel('data/labs.xlsx')
tf <- read_excel('data/tf.xlsx') %>% 
  mutate(fileid = gsub('.vital', '', fileid)) %>% 
  distinct() # there are some duplicated rows in tf
skimr::skim(tf)
# skimr::skim(cases)
```

```{r}
massive_trans <- tf %>% 
  filter(grepl('#', val), # only consider rows with #
         !grepl('cont', val),
         !val %in% c(' #', '#!', '#0316454', 'on #0')) %>% 
  mutate(val = gsub('[?()]', '', val) %>% 
           gsub('[~=]', '-', .) %>% 
           gsub('#9-`1', '#9-12', .) %>% # continuous transfusion for D1_160720_000512
           gsub('#1400cc', '#1', .) %>% # first transfusion of 400cc for D4_191003_082024
           gsub('#17,18,1', '#17,18', .) %>% # continuous transfusion for E5_180907_075903
           gsub('#11,12,1', '#11,12', .) %>% # continuous transfusion for A4_180528_103731
           gsub('#25-289', '#25-28', .) %>% # continuous transfusion for D1_180419_143306
           gsub('#35-#474', '#35-44', .) %>% # continuous transfusion for F4_160803_115114
           gsub('#9#10#11', '#9-11', .) %>% # D5_160901_172629
           gsub('FMS|FM|CPB|B\\+|hold|on|fro| |resume|pheres', '', .))

```


## Special cases
Will manually add `D5_190109_124529` from discussion with Seung Mi:
"This patient started 1st, 2nd transfusion at 2019-01-09 13:40, and the 2nd transfusion ended at 2019-01-09 13:50. The 3rd-6th (4 RBC) transfusion started at 2019-01-09 13:55, and all of them ended at 2019-01-09 14:00. And the 7th-10th transfusion started at 2019-01-09 14:05, and all of them ended at 2019-01-09 14:10."
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'D5_190109_124529')
```

Similarly, `D1_180727_110744` has massive transfusion:
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'D1_180727_110744')
```

The patient `C4_190617_074206` underwent `Spondylectomy : en-bloc spondylectomy, thoracic` and the `sum_ebl` (estimated blood loss during surgery) was 25800 and the `sum_rbc` was 66 (transfision of 66 rbc). This also acutally happended during operation. This type of massive transfusion is not normal and may have been not expected before operation, and if we can predict that, we can prepare that situation. I think that is the purpose of our project.
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'C4_190617_074206')
```

Let's add these to `mt_patients` for now:
```{r}
mt_patients <- c('D5_190109_124529', 'D1_180727_110744', 'C4_190617_074206')
```

On the other hand, only one row for `D4_191111_185103`:
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'D4_191111_185103')
```
so this patient did not have massive transfusion.


Also, `C4_190508_124038` does not have massive transfusion:
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'C4_190508_124038')
```

`D2_181018_132531`: The patient underwent `Repair of aneurysm ( AAA )  : retroperitoneal approach or medial visceral rotation, supraceliac clamping` and I think that 140 transfusion within 7 hours is possible during that operation.
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'D2_181018_132531')
```

`A2_190228_141759` underwent `Total hysterectomy ( multiport laparoscopy assisted vaginal )  : LAVH-BSO `. The surgery usually does not cause massive transfusion, but the `sum_rbc` during surgery was '63' in cases file, and she died after the surgery. This was not normal situation but this actually happened.
```{r echo=FALSE}
massive_trans %>% filter(fileid == 'A2_190228_141759')
```


```{r}
# massive_trans %>% filter(grepl('\\.', val)) %>% select(-fileid)
# Also needs to replace . with -
massive_trans <- massive_trans %>% 
  filter(val != '#',
         !fileid %in% c('D5_190109_124529', 'D1_180727_110744', 'D4_191111_185103', 'C4_190508_124038', 'C4_190617_074206'
                        #, 'C2_190905_073807'
                        )) %>% 
  mutate(val = gsub('\\.', '-', val))

massive_trans$conv_val <- sapply(massive_trans$val, get_num_list)
```


```{r}
all_trans <- massive_trans %>%
  mutate(sep_val = conv_val) %>% 
  tidyr::separate_rows(sep_val, sep = ',') %>%
  mutate(sep_val = as.integer(sep_val))

mt_patients <- mt_patients %>% 
  c(massive_trans %>% 
      subset(sapply(str_locate_all(massive_trans$conv_val, ','), nrow) > 1) %>% 
      pull(fileid) %>% 
      unique())

patients_to_check <- setdiff(unique(all_trans$fileid), mt_patients)

for (patient in patients_to_check){
  df_i <- all_trans %>% filter(fileid == patient)
  diff_h <- vector()

  for (i in 3:max(df_i$sep_val)){
    if ((i %in% df_i$sep_val) && (sum(df_i$sep_val <= (i-2)) > 0)){
      pre_idx <- max(df_i$sep_val[df_i$sep_val <= (i-2)])

      t2 <- df_i %>% filter(sep_val == i) %>% pull(dt)
      t1 <- df_i %>% filter(sep_val == pre_idx) %>% pull(dt)
      diff_h <- c(diff_h, difftime(t2, t1, units = 'hours') %>% as.numeric())
    }
  }
  if (any(diff_h < 1))
    mt_patients <- c(mt_patients, patient)
}

```


```{r}
phenotypes <- data.frame(fileid = unique(massive_trans$fileid)) %>% 
  mutate(had_mass_trans = (fileid %in% mt_patients))

table(phenotypes$had_mass_trans)
phenotypes %>% readr::write_csv('data/mass-trans-phenotype.csv')

tf %>% 
  left_join(phenotypes, by = 'fileid') %>% 
  readr::write_csv('data/tf_pheno.csv')

tf_pheno <- tf %>% 
  left_join(phenotypes, by = 'fileid') 

cases %>% 
  left_join(phenotypes, by = 'fileid') %>% 
  readr::write_csv('data/case_pheno.csv')
```


Check: `C1_191121_080136` should have massive transfusion.
`D4_191003_082024` should not.

```{r echo=FALSE}
phenotypes %>% filter(fileid %in% c('C1_191121_080136', 'D4_191003_082024'))
```


## Investigate patients with duplicated transfusion `val`:
**(Seung Mi please check!)**
```{r}
more_pats_to_check <- all_trans %>% 
  add_count(fileid, name = 'num_events') %>% 
  filter(num_events >= 3) %>% 
  count(fileid, sep_val) %>% 
  filter(n > 1) %>% 
  pull(fileid) %>% 
  unique()

why <- all_trans %>% filter(fileid %in% more_pats_to_check) %>% 
  left_join(phenotypes, by = 'fileid')

check_patients_neg <- setdiff(more_pats_to_check, mt_patients)
check_patients_pos <- intersect(more_pats_to_check, mt_patients)

```

Check if negative is correct:
```{r echo}
check_neg <- why %>%
  filter(fileid %in% check_patients_neg) %>% group_by(fileid) %>% 
  summarise(min_diff = min(diff(dt, lag = 2), na.rm = TRUE)) %>% 
  filter(min_diff < 3600 |is.infinite(min_diff)) %>% 
  pull(fileid)

why %>% 
  filter(fileid %in% check_neg) %>% 
  select(- c(conv_val, sep_val)) %>% 
  distinct() %>%
  DT::datatable()
```


```{r echo=FALSE}
massive_trans %>% filter(fileid == 'C2_190905_073807')
```



Check if possitive is correct:
```{r}
why_neg <- why %>%
  filter(fileid %in% check_patients_pos) %>% group_by(fileid) %>% 
  mutate(min_diff = min(diff(dt, lag = 2), na.rm = TRUE)) %>% 
  # filter(min_diff >= 3600 |is.infinite(min_diff)) %>%
  {.}
  
```
I have manually checked these patients.
Most of the phenotype seem correct, except the following patients which need further investigation:

```{r}
why %>% 
  filter(
    fileid %in% c('C4_190823_074052', 'D1_190905_201426', 'D1_190923_095547', 'F2_180816_095513', 'A5_180504_073943', 'C2_190905_073807')
  ) %>% 
  select(- c(conv_val, sep_val)) %>% 
  distinct() %>%
  DT::datatable()
```
`C2_190905_073807` did not have massive transfusion?
Should we replace `#3-1`, `#3-2`, `#3-3` with `#1`, `#2`, `#3`?
